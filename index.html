<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" type="image/png" href="Screenshot 2025-09-24 175434.png">
    <title>Urbanision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto+Mono:wght@100..700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a101f;
            color: #e5e7eb;
            background-image:
                linear-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.05) 1px, transparent 1px);
            background-size: 35px 35px;
            animation: pan-background 60s linear infinite;
        }

        @keyframes pan-background {
            from { background-position: 0 0; }
            to { background-position: 350px 350px; }
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        .header-bg {
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid #374151;
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.1);
            border-radius: 12px;
        }

        .tab-button {
            font-family: 'Roboto Mono', monospace;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            border: 1px solid #374151;
            background-color: rgba(31, 41, 55, 0.5);
            color: #9CA3AF;
        }
        .tab-button:hover {
            background-color: rgba(56, 189, 248, 0.1);
            border-color: rgba(56, 189, 248, 0.5);
            color: #f0f9ff;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
        }
        .tab-button.active {
            background-color: #38bdf8;
            color: #111827;
            font-weight: 700;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5), inset 0 0 5px rgba(255,255,255,0.3);
            transform: translateY(-2px);
            border-color: #38bdf8;
        }

        .data-card, .content-column {
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        .data-card:hover, .content-column:hover {
            transform: translateY(-3px);
            border-color: rgba(56, 189, 248, 0.7);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.25);
        }
        .content-column {
             padding: 2rem;
        }

        #generate-plan-btn {
            background-image: linear-gradient(to right, #0891b2, #38bdf8, #0891b2);
            background-size: 200% auto;
            border: none;
            transition: all 0.4s ease;
        }
        #generate-plan-btn:hover:not(:disabled) {
            background-position: right center;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.6);
        }
        #generate-plan-btn:disabled {
            background: #374151;
        }

        main > div {
            animation: fadeIn 0.6s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-ring {
            border: 4px solid #ffffff33;
            border-top: 4px solid #e0f2fe;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        ::-webkit-scrollbar-track { background: #111827; }

        .slider-track {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 4px;
            outline: none;
            transition: opacity .2s;
        }
        .slider-track::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #38bdf8;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
            transition: transform 0.2s ease;
        }
        .slider-track::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        video-container {
            border: 4px solid #374151; 
            background-color: #000000; 
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15); 
            position: relative;
            overflow: hidden;
        }
        .video-feed-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: #10b981; 
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            font-family: 'Roboto Mono', monospace;
            z-index: 10;
            border-right: 1px solid #10b981;
        }


        #plan-content h3 {
            font-family: 'Roboto Mono', monospace;
            color: #7dd3fc;
            font-size: 1.125rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            margin-top: 1.5rem;
            border-bottom: 1px solid #374151;
        }

        #plan-content h3:first-child {
            margin-top: 0;
        }

        #plan-content strong {
            color: #38bdf8;
            font-weight: 600;
        }

        #plan-content p {
            line-height: 1.6;
            color: #d1d5db;
        }

        #plan-content ul {
            list-style-type: none;
            padding-left: 0.5rem;
        }

        #plan-content li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        #plan-content li::before {
            content: '>';
            position: absolute;
            left: 0;
            top: 0.1rem;
            color: #38bdf8;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
        }

        .data-stream-animation {
            background: #000;
            position: relative;
            overflow: hidden;
        }
        .data-stream-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: move-grid 2s linear infinite;
        }
      
        }
        @keyframes move-grid {
            from { background-position: 0 0; }
            to { background-position: 20px 20px; }
        }
        @keyframes scan-line {
            0% { transform: translateY(0); }
            100% { transform: translateY(200%); }
        }
        /* Leaflet popup/control custom styling */
        .leaflet-popup-content-wrapper, .leaflet-control-layers {
            background-color: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(5px);
            color: #e5e7eb;
            border-radius: 8px;
            border: 1px solid #4b5563;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .leaflet-popup-content {
            font-family: 'Roboto Mono', monospace;
        }
        .leaflet-popup-content h5 {
            font-weight: bold;
            color: #7dd3fc;
            margin-bottom: 5px;
        }
        .leaflet-popup-tip {
            background-color: #1f2937;
        }
        .leaflet-control-layers-base label, .leaflet-control-layers-overlays label {
            font-family: 'Roboto Mono', monospace;
        }
        .leaflet-control-attribution a {
            color: #38bdf8;
        }
        .legend {
            line-height: 18px;
            color: #e5e7eb;
        }
    </style>
</head>
<body class="p-4 md:p-10 min-h-screen">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10 p-8 header-bg">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-2 uppercase tracking-widest text-gray-300 font-mono">
                <span style="color: #38bdf8;">Urbanision</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-400 font-light font-mono">
                <span class="text-green-500">TARGET:</span> KARACHI - ANALYSIS (<span class="text-cyan-400">BENCHMARK: NYC</span>)
            </p>
            <div class="h-0.5 bg-gray-700 mt-4 rounded-full max-w-md mx-auto"></div>
        </header>

        <div class="mb-10 flex flex-wrap justify-center gap-3">
            <button id="tab-mobility" class="tab-button active" data-tab="mobility">01. MOBILITY</button>
            <button id="tab-housing" class="tab-button" data-tab="housing">02. HOUSING</button>
            <button id="tab-air" class="tab-button" data-tab="air">03. AIR/CLIMATE</button>
            <button id="tab-coastal" class="tab-button" data-tab="coastal">04. COASTAL</button>
            <button id="tab-waste" class="tab-button" data-tab="waste">05. WASTE</button>
            <button id="tab-feed" class="tab-button" data-tab="feed">06. BRIEFING</button>
            <button id="tab-sim" class="tab-button" data-tab="sim">07. URBAN SIM</button>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div id="crisis-column" class="content-column lg:col-span-1 space-y-6 border-t-4 border-red-500">
                <h2 class="text-xl font-bold uppercase text-red-400 flex items-center font-mono">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    CRISIS METRICS - <span id="city-title">KARACHI</span>
                </h2>
                <p class="text-xs text-gray-500 font-mono border-b border-gray-700 pb-2">Status: CRITICAL. Data layers confirmed.</p>
                <div id="content-crisis" class="space-y-6">
                </div>
            </div>

            <div id="action-plan-column" class="content-column lg:col-span-2 border-t-4 border-cyan-500">
                <h2 class="text-2xl font-bold mb-6 text-cyan-400 flex items-center uppercase tracking-wider font-mono">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-4m0 0V8m0 4h4m-4 0h-4m8 0h4m-4 0v4m0-4h4" />
                      <circle cx="12" cy="12" r="10" />
                    </svg>
                    Strategic Action Protocol
                </h2>

                <div id="content-action-plan" class="space-y-8">
                    <div id="default-message" class="p-6 text-gray-400 bg-black/20 rounded-lg border border-gray-700">
                        <p class="text-sm font-semibold text-cyan-300 font-mono">Awaiting Input:</p>
                        <p class="mt-2 text-sm text-gray-300">Select a crisis area (01-05) to initiate the SSOT analysis or view the BRIEFING (06).</p>
                    </div>

                    <div id="feed-content" class="hidden">
                        <h3 class="text-xl font-bold mb-5 text-cyan-400 font-mono uppercase border-b border-gray-700 pb-2">
                            06. MISSION BRIEFING: System Overview
                        </h3>

                        <div class="video-container aspect-video w-full">
                            <div id="live-video-player" class="w-full h-full data-stream-animation">
                          <video class="w-full h-full object-cover" controls autoplay loop muted playsinline>
                                    <source src="Project video.mp4"    type="video/mp4">
                                    Your browser does not support the video tag. Please use a modern browser.
                                </video>    
                        </div>
                            <div class="video-feed-label text-red-400 border-red-400">STATUS | BRIEFING</div>
                        </div>

                        <div class="mt-6 p-4 bg-black/20 rounded-lg border-l-4 border-cyan-500 text-gray-300">
                            <p class="font-bold text-cyan-400 mb-1 font-mono">DATA STREAM ANNOTATION:</p>
                            <p class="text-sm">This briefing outlines the Urbanision System, the SSOT methodology, and the strategic rationale for the Karachi urban planning target.</p>
                        </div>
                    </div>

                    <div id="sim-content" class="hidden">
                        <h3 class="text-xl font-bold mb-5 text-cyan-400 font-mono uppercase border-b border-gray-700 pb-2">
                            07. URBAN RESILIENCE SIMULATOR
                        </h3>
                        <div class="p-6 bg-black/20 rounded-lg border border-gray-700 mb-6">
                            <p class="font-bold text-cyan-300 mb-2 font-mono">TASK: Allocate 100 Billion PKR Budget</p>
                            <p class="text-sm text-gray-400">Distribute your available budget across the five crisis areas. Your allocation will generate a hypothetical **Resilience Impact Score (RIS)**.</p>
                        </div>

                        <div class="mt-4 p-4 bg-yellow-900/30 rounded-lg border-l-4 border-yellow-500 mb-6">
                            <p class="font-bold text-yellow-400 mb-1 font-mono">CURRENT ALLOCATION:</p>
                            <div class="flex justify-between items-center font-mono">
                                <span id="current-allocation-display" class="text-2xl font-extrabold text-yellow-500">0</span>
                                <span class="text-xl font-bold text-gray-300">/ 100 Billion PKR</span>
                            </div>
                        </div>
                        <div id="sim-sliders" class="space-y-6">
                            </div>

                        <div class="mt-8 pt-6 border-t border-gray-700">
                            <button id="calculate-sim-btn" class="w-full bg-green-600 hover:bg-green-700 text-gray-900 font-extrabold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50 flex items-center justify-center uppercase tracking-wider font-mono">
                                RUN SIMULATION & CALCULATE RIS
                            </button>
                        </div>

                        <div id="sim-results" class="hidden mt-8 p-6 text-sm">
                            <h4 class="font-bold mb-3 uppercase font-mono">Simulation Output: Year 3 Impact Forecast</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-gray-300">Total Allocated Budget:</p>
                                    <p id="total-allocated" class="text-xl font-bold text-red-300 font-mono">0 PKR</p>
                                </div>
                                <div>
                                    <p class="text-gray-300">Resilience Impact Score (RIS):</p>
                                    <p id="ris-score" class="text-3xl font-extrabold font-mono">0.0</p>
                                </div>
                            </div>
                            <p id="ris-message" class="mt-4 text-gray-200 text-sm italic"></p>
                        </div>
                    </div>
                    <div id="plan-display" class="hidden">
                        <div id="plan-display-inner" class="space-y-6 pt-4 border-t border-gray-700">
                            <h3 class="text-xl font-bold text-cyan-400 font-mono uppercase">Output: Strategic Recommendations</h3>
                            <div id="plan-content">
                                </div>
                        </div>
                    </div>

                    <div id="data-layers-display" class="hidden pt-4 border-t border-gray-700">
                        <h3 class="text-xl font-bold mb-5 text-green-400 font-mono uppercase">Referenced Internal Data Layers (SSOT)</h3>
                        <p class="text-xs text-gray-500 mb-4 font-mono">Grounded Data. Zero External Research Required.</p>
                        <div id="data-layers-content" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        </div>
                    </div>
                </div>

                <div class="mt-10">
                    <button id="generate-plan-btn" class="w-full text-gray-900 font-extrabold py-4 px-6 rounded-lg uppercase tracking-wider font-mono" disabled>
                        <span id="button-text">Execute Protocol for KARACHI: <span id="current-tab-name" class="font-mono">MOBILITY</span></span>
                        <div id="loading-spinner" class="loading-ring ml-3 hidden"></div>
                    </button>
                    <p id="error-message" class="text-red-500 mt-4 text-center hidden font-mono text-sm">Error: API Key Required to Establish Connection (403)</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let map = null; // Manage the map instance globally
        
        // --- API KEY CHANGE ---
        // IMPORTANT: Replace "YOUR_REAL_API_KEY_HERE" with your actual API key from Google AI Studio.
        const apiKey = "AIzaSyAkURgooE03sq2VuyUzVYgIfpT4vBfj1yc";
        
        const MODEL_NAME = "gemini-2.5-flash";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // Data points for various maps
        const MAP_DATA = {
            pollutionHotspots: [
                { lat: 24.886, lon: 67.025, name: 'S.I.T.E Industrial Area', severity: 'High', type: 'Heavy Industry, Textiles' },
                { lat: 24.823, lon: 67.14, name: 'Korangi Industrial Area', severity: 'High', type: 'Tanneries, Pharma, Textiles' },
                { lat: 24.81, lon: 67.19, name: 'Landhi Industrial Area', severity: 'High', type: 'Manufacturing, Power Plants' },
                { lat: 24.78, lon: 67.33, name: 'Port Qasim Industrial Zone', severity: 'Critical', type: 'Steel Mills, Power, Port Ops' },
                { lat: 24.96, lon: 67.04, name: 'Federal B Industrial Area', severity: 'Medium', type: 'Light Industry, Manufacturing' }
            ],
            informalSettlements: [
                { lat: 24.93, lon: 66.95, name: 'Orangi Town', detail: 'One of Asia\'s largest informal settlements.' },
                { lat: 24.87, lon: 66.99, name: 'Lyari', detail: 'Historic, densely populated settlement.' },
                { lat: 24.83, lon: 66.98, name: 'Machar Colony', detail: 'Coastal settlement facing significant environmental challenges.' },
                { lat: 24.99, lon: 67.07, name: 'Sohrab Goth', detail: 'Major informal settlement and transport hub.' }
            ],
            wasteSites: [
                { lat: 25.04, lon: 66.90, name: 'Jam Chakro Landfill', type: 'Official Landfill' },
                { lat: 24.89, lon: 67.33, name: 'Gondal Pass Dumpsite', type: 'Official Landfill' },
                { lat: 24.83, lon: 67.04, name: 'Malir Riverbed', type: 'Informal Dumpsite' }
            ],
            coastalAssets: [
                { lat: 24.8, lon: 67.2, name: 'Coastal Mangrove Belt', type: 'Protected Ecosystem' },
                { lat: 24.79, lon: 67.1, name: 'Industrial Effluent Zone', type: 'Potential Discharge Area' }
            ]
        };

        async function fetchLiveAQI() {
            const aqicnApiKey = 'ff5e27e8246503934ef93a8ad49cbb53b78968c4';
            const city = 'karachi';
            const aqicnApiUrl = `https://api.waqi.info/feed/${city}/?token=${aqicnApiKey}`;

            try {
                const response = await fetch(aqicnApiUrl);
                if (!response.ok) {
                    console.error("Failed to fetch AQI data. Status:", response.status);
                    return null;
                }
                const data = await response.json();
                if (data.status === "ok" && data.data && data.data.aqi) {
                    console.log("Successfully fetched live AQI:", data.data.aqi);
                    return data.data.aqi;
                } else {
                    console.error("AQI data not found in API response.");
                    return null;
                }
            } catch (error) {
                console.error("Error fetching AQI data:", error);
                return null;
            }
        }

        const DATA_CATALOG = {
            "GHSL Density Maps": { title: "GHSL Population Density (1km Proximity)", description: "High-density residential areas outside 1km transit proximity. Shows a critical transit deficit of 3.4 million unserved residents.", source: "NASA/GHSL" },
            "Aggregated Mobility/GPS Data": { title: "Aggregated Mobility/GPS Data (OD Analysis)", description: "Anonymized mobile/ride-hailing data. Confirms 65% of all daily trips in the unserved corridor use informal transport.", source: "MNO/GIS Partners" },
            "Transit Demand Corridors": { title: "Critical Transit Demand Corridors (GIS Overlay)", description: "Vector layer identifying 3 high-volume, low-service transport channels that must be prioritized for BRT/LRT development.", source: "GIS/Transport Modeling" },
            "Housing Stress Index (HSI)": { title: "Housing Stress Index (HSI)", description: "A composite score (0-100) combining flood risk (DEMs) and informal housing density (GHSL). Average HSI in critical areas like Korangi is 88.", source: "EO Derived Metric" },
            "Sentinel-1/2 Service Access Proxy": { title: "Sentinel-1/2 Service Access Proxy", description: "EO-based layer showing distance to formalized infrastructure lines (roads, utilities). 75% of structures in katchi abadis are >200m from a formal utility connection.", source: "ESA/Sentinel" },
            "WorldPop Density": { title: "WorldPop Population Density", description: "High-resolution population counts (100m grid). Confirms 53% of the city's population resides in areas classified as unplanned settlements.", source: "NASA/WorldPop" },
            "Copernicus Sentinel-5P": { title: "Sentinel-5P Air Quality (PM2.5/NO2 Hotspot Map)", description: "High-resolution PM2.5 and NO2 concentration data. Identifies two new industrial emission hotspots near Port Qasim requiring immediate inspection.", source: "ESA/Sentinel-5P" },
            "MODIS LST": { title: "MODIS Land Surface Temperature (UHI Intensity)", description: "Thermal imaging data. Confirms Urban Heat Island intensity is 4Â°C higher in central business districts compared to coastal areas, escalating heat-related illness risk.", source: "NASA/MODIS" },
            "Source Apportionment Analysis": { title: "Source Apportionment Analysis (Modeled)", description: "Modeling results differentiating pollutant sources. Vehicular emissions account for 45% of total PM2.5, followed by industrial sources at 30%.", source: "Chemical Transport Model" },
            "Sentinel-2 Multi-spectral Imagery": { title: "Sentinel-2 Multi-spectral Imagery (Effluent/Turbidity)", description: "Water quality data. Detected two large turbidity plumes entering the Arabian Sea, originating from documented industrial areas, indicating illegal effluent discharge.", source: "ESA/Sentinel-2" },
            "NDVI/NDWI Degradation Analysis": { title: "NDVI/NDWI Mangrove Degradation Analysis", description: "Time-series index analysis showing a 15% net reduction in mangrove forest health (NDVI) over the last decade due to encroachment.", source: "NASA/EO Indices" },
            "HRSI/LULC Waste Hotspot Map": { title: "HRSI/LULC Waste Hotspot Map", description: "High-Resolution Satellite and Land Use map of uncollected waste. Shows 12 major informal dumpsites, totaling 45 hectares, primarily near arterial roads.", source: "HRSI/GIS Mapping" },
            "WRI Waste Data": { title: "WRI Waste Data (Generation Rates)", description: "Validated municipal and WRI data. Waste generation rate is 0.75 kg/capita/day in formal zones vs. 0.95 kg/capita/day in low-income zones.", source: "WRI/Ground Survey" },
        };

        const CHART_COLORS = {
            mobility: { labels: ['Far from Transit (>1km)', 'Near Transit (<1km)', 'Non-Mobile'], values: [65, 25, 10], bg: ['#ef4444', '#10b981', '#4b5563'] },
            housing: { labels: ['Informal Housing', 'Formal Housing', 'Unused'], values: [53, 37, 10], bg: ['#ef4444', '#38bdf8', '#4b5563'] },
            air: { labels: ['PM2.5 Level (Karachi)', 'WHO Target (50)', 'Vehicular Emissions'], values: [155, 50, 45], bg: ['#f97316', '#10b981', '#38bdf8'] },
            coastal: { labels: ['Mangrove Loss', 'Stable', 'Gain'], values: [15, 80, 5], bg: ['#ef4444', '#10b981', '#38bdf8'] },
            waste: { labels: ['Uncollected/Dumped', 'Collected'], values: [35, 65], bg: ['#ef4444', '#38bdf8'] }
        };

        const CRISIS_DATA = {
            mobility: {
                title: "MOBILITY",
                eoSource: "GHSL Density Maps, Aggregated Mobility/GPS Data",
                promptCategory: "MOBILITY",
                dataLayers: ["GHSL Density Maps", "Aggregated Mobility/GPS Data", "Transit Demand Corridors"],
                karachi: { metric: "Population > 1km from Mass Transit", value: "65%", insight: "This 65% relies on private or informal transport, worsening congestion and requiring investment in the **Transit Demand Corridors**." },
                nyc: { benchmarkMetric: "Population > 1km from Mass Transit (NYC)", benchmarkValue: "3%", benchmarkInsight: "NYC's mature network ensures high coverage. The focus is on maintenance and last-mile connections." },
                simFactor: 0.5,
                map: { title: "MOBILITY ANALYSIS LAYERS", theme: 'mobility'}
            },
            housing: {
                title: "HOUSING",
                eoSource: "WorldPop Density, Housing Stress Index (HSI)",
                promptCategory: "HOUSING/INFORMALITY",
                dataLayers: ["Housing Stress Index (HSI)", "Sentinel-1/2 Service Access Proxy", "WorldPop Density"],
                karachi: { metric: "Population in Informal Housing", value: "53%", insight: "Over half the population lives in unplanned settlements, facing service deficits as shown by the **Sentinel-1/2 Service Access Proxy**." },
                nyc: { benchmarkMetric: "Population in Overcrowded Units (NYC)", benchmarkValue: "5%", benchmarkInsight: "NYC manages density through strict zoning and public housing; the focus is on maximizing infill." },
                simFactor: 0.3,
                map: { title: "MAJOR INFORMAL SETTLEMENTS", theme: 'housing'}
            },
            air: {
                title: "AIR/CLIMATE",
                eoSource: "Copernicus Sentinel-5P, MODIS LST",
                promptCategory: "AIR/CLIMATE",
                dataLayers: ["Copernicus Sentinel-5P", "MODIS LST", "Source Apportionment Analysis"],
                karachi: { metric: "Average PM2.5 AQI (Unhealthy)", value: "155", insight: "High AQI is driven by vehicular and industrial emissions, requiring intervention based on **Source Apportionment Analysis**." },
                nyc: { benchmarkMetric: "Average PM2.5 AQI (NYC)", benchmarkValue: "55", benchmarkInsight: "AQI is near the WHO target, focusing on reducing building emissions and vehicle idling." },
                simFactor: 0.8,
                map: { title: "AIR POLLUTION HOTSPOTS (SENTINEL-5P NO2)", theme: 'air'}
            },
            coastal: {
                title: "COASTAL",
                eoSource: "Sentinel-2, NDVI/NDWI Degradation Analysis",
                promptCategory: "COASTAL INTEGRITY",
                dataLayers: ["Sentinel-2 Multi-spectral Imagery", "NDVI/NDWI Degradation Analysis"],
                karachi: { metric: "Mangrove Health Net Reduction (10 yr)", value: "15%", insight: "Severe mangrove loss confirmed by **NDVI/NDWI Analysis**, driven by encroachment and effluent dumping visible in **Sentinel-2**." },
                nyc: { benchmarkMetric: "Wetland Habitat Integrity (NYC)", benchmarkValue: "95/100", benchmarkInsight: "Strict zoning and protection of wetlands ensures high integrity, crucial for climate resilience." },
                simFactor: 0.7,
                map: { title: "COASTAL ASSETS & EFFLUENT RISKS (SENTINEL-2)", theme: 'coastal'}
            },
            waste: {
                title: "WASTE",
                eoSource: "HRSI/LULC Waste Hotspot Map, WRI Data",
                promptCategory: "WASTE MANAGEMENT",
                dataLayers: ["HRSI/LULC Waste Hotspot Map", "WRI Waste Data"],
                karachi: { metric: "Uncollected Waste Rate", value: "35%", insight: "The **HRSI/LULC Map** identifies 12 major dumpsites, linked to higher generation rates in low-income zones per **WRI Data**." },
                nyc: { benchmarkMetric: "Residential Diversion Rate (NYC)", benchmarkValue: "30%", benchmarkInsight: "NYC focuses on improving source segregation to boost the current 30% diversion rate and reduce landfill volume." },
                simFactor: 0.9,
                map: { title: "MAJOR LANDFILLS & DUMPSITES (HRSI)", theme: 'waste'}
            },
            feed: {
                title: "BRIEFING",
                eoSource: "PROJECT BRIEFING - Mission Control",
                isFeed: true,
                karachi: { metric: "System Status", value: "ONLINE", insight: "Briefing on the Urbanision system and SSOT methodology for urban planning." },
                nyc: { benchmarkMetric: "Briefing Duration", benchmarkValue: "0:34", benchmarkInsight: "Duration of the Mission Briefing video." }
            },
            sim: {
                title: "URBAN SIM",
                eoSource: "SIMULATION MODULE - Resource Allocation",
                isSim: true,
                karachi: { metric: "Total Budget", value: "100 Billion PKR", insight: "A simulation environment to test resource allocation across critical urban sectors." },
                nyc: { benchmarkMetric: "Simulation Horizon", benchmarkValue: "3 Years", benchmarkInsight: "The forecast horizon for the calculated Resilience Impact Score (RIS)." }
            }
        };

        Object.keys(CRISIS_DATA).forEach(key => {
            if (key !== 'feed' && key !== 'sim') {
                CRISIS_DATA[key].karachi.chartData = CHART_COLORS[key];
            }
        });

        const SIM_AREAS = [
            { id: 'sim-mobility', label: 'Mobility/Transit Infrastructure', crisisData: CRISIS_DATA.mobility },
            { id: 'sim-housing', label: 'Informal Settlement Upgrading', crisisData: CRISIS_DATA.housing },
            { id: 'sim-air', label: 'Emissions Regulation/Green Zones', crisisData: CRISIS_DATA.air },
            { id: 'sim-coastal', label: 'Mangrove/Coastal Protection', crisisData: CRISIS_DATA.coastal },
            { id: 'sim-waste', label: 'Waste Collection/Recycling', crisisData: CRISIS_DATA.waste },
        ];

        const TOTAL_BUDGET = 100;

        function generateSimSliders() {
            const slidersContainer = document.getElementById('sim-sliders');
            slidersContainer.innerHTML = '';
            SIM_AREAS.forEach(area => {
                const div = document.createElement('div');
                div.className = 'data-card p-4 bg-black/20 rounded-lg';
                div.innerHTML = `
                    <div class="slider-label">
                        <span class="text-gray-300 font-mono">${area.label}</span>
                        <span id="${area.id}-value" class="text-cyan-400 font-extrabold font-mono">0 Billion PKR</span>
                    </div>
                    <input type="range" min="0" max="${TOTAL_BUDGET}" value="0" step="1" class="slider-track" id="${area.id}-slider" data-area="${area.id}">
                `;
                slidersContainer.appendChild(div);
            });
        }

        function updateSimTotal() {
            let total = 0;
            const sliders = document.querySelectorAll('#sim-sliders input[type="range"]');
            sliders.forEach(slider => { total += parseInt(slider.value); });

            if (total > TOTAL_BUDGET) {
                const excess = total - TOTAL_BUDGET;
                const lastSlider = sliders[sliders.length - 1];
                const lastValue = parseInt(lastSlider.value);
                const newValue = Math.max(0, lastValue - excess);
                lastSlider.value = newValue;
            }

            total = 0;
            sliders.forEach(slider => {
                const val = parseInt(slider.value);
                total += val;
                document.getElementById(`${slider.dataset.area}-value`).textContent = `${val} Billion PKR`;
            });

            document.getElementById('current-allocation-display').textContent = total;
            document.getElementById('sim-results').classList.add('hidden');
        }

        function calculateResilienceImpact() {
            let totalAllocated = 0;
            let rawImpactScore = 0;
            const MAX_RAW_IMPACT = TOTAL_BUDGET * 0.9;

            SIM_AREAS.forEach(area => {
                const slider = document.getElementById(`${area.id}-slider`);
                const allocation = parseInt(slider.value);
                totalAllocated += allocation;
                rawImpactScore += allocation * area.crisisData.simFactor;
            });

            const risNormalized = parseFloat(((rawImpactScore / MAX_RAW_IMPACT) * 10).toFixed(1));

            const resultsEl = document.getElementById('sim-results');
            resultsEl.classList.remove('hidden');
            document.getElementById('total-allocated').textContent = `${totalAllocated} Billion PKR`;
            document.getElementById('ris-score').textContent = risNormalized.toFixed(1);

            let risMessage = '';
            const baseResultsClasses = 'mt-8 p-6 rounded-lg border-l-4';
            const baseScoreClasses = 'text-3xl font-extrabold font-mono';
            const headerEl = resultsEl.querySelector('h4');

            if (risNormalized >= 7.0) {
                risMessage = 'Excellent Impact. The allocation demonstrates a strong focus on high-yield, short-term crisis mitigation.';
                resultsEl.className = `${baseResultsClasses} bg-green-900/30 border-green-500`;
                document.getElementById('ris-score').className = `${baseScoreClasses} text-green-500`;
                headerEl.className = 'font-bold text-green-400 mb-3 uppercase font-mono';
            } else if (risNormalized >= 4.0) {
                risMessage = 'Moderate Impact. The strategy is balanced but may lack the critical mass needed for lasting change in complex sectors.';
                resultsEl.className = `${baseResultsClasses} bg-yellow-900/30 border-yellow-500`;
                document.getElementById('ris-score').className = `${baseScoreClasses} text-yellow-500`;
                headerEl.className = 'font-bold text-yellow-400 mb-3 uppercase font-mono';
            } else {
                risMessage = 'Low Impact. The allocation is spread too thin or disproportionately focused on areas with low near-term crisis impact.';
                resultsEl.className = `${baseResultsClasses} bg-red-900/30 border-red-500`;
                document.getElementById('ris-score').className = `${baseScoreClasses} text-red-500`;
                headerEl.className = 'font-bold text-red-400 mb-3 uppercase font-mono';
            }
            document.getElementById('ris-message').textContent = risMessage;
        }

        generateSimSliders();
        document.getElementById('sim-sliders').addEventListener('input', updateSimTotal);
        document.getElementById('calculate-sim-btn').addEventListener('click', calculateResilienceImpact);

        function getMentionedLayers(planText) {
            const mentionedLayers = [];
            const keywords = Object.keys(DATA_CATALOG);
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '\\$1')}\\b`, 'gi');
                if (regex.test(planText)) {
                    if (!mentionedLayers.some(layer => layer.keyword === keyword)) {
                        mentionedLayers.push({ keyword, data: DATA_CATALOG[keyword] });
                    }
                }
            });
            return mentionedLayers;
        }

        async function generatePlanAndData(tabName) {
            const tabData = CRISIS_DATA[tabName];
            const relevantLayers = tabData.dataLayers.map(layer => `**${layer}**`).join(', ');
            const prompt = `Develop a strategic, data-driven action plan for the major crisis in ${tabData.title} in Karachi. Contextualize the plan using the following data: Karachi Metric: ${tabData.karachi.metric} is ${tabData.karachi.value} (Insight: ${tabData.karachi.insight}). Benchmark Metric: ${tabData.nyc.benchmarkMetric} is ${tabData.nyc.benchmarkValue}. Your rationale must explicitly cite and bold these key internal data layers: ${relevantLayers}.`;

            const button = document.getElementById('generate-plan-btn');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');
            const errorEl = document.getElementById('error-message');

            button.disabled = true;
            buttonText.textContent = `PROTOCOL EXECUTING...`;
            spinner.classList.remove('hidden');
            errorEl.classList.add('hidden');

            let planText = '';

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{
                            text: `You are an expert urban planning strategist AI for the Urbanision System. Your analysis must be brief, data-driven, and highly structured.

                            Your response MUST strictly follow this Markdown format:

                            ### 1. Executive Summary
                            A single, concise paragraph summarizing the core problem and the proposed strategic direction.

                            ### 2. Key Recommendations
                            - **Initiative A:** (e.g., **BRT Corridor Development**) A brief description of the first major action.
                            - **Initiative B:** (e.g., **Informal Transit Regulation**) A brief description of the second major action.

                            ### 3. Data-Driven Rationale
                            A short explanation of how the recommendations are directly supported by the provided crisis metrics and data layers (e.g., "The focus on BRT is justified by the **GHSL Density Maps**...").

                            ### 4. Success Metrics (KPIs)
                            - **KPI 1:** A measurable target to track progress (e.g., "Reduce population >1km from transit by 20% in 3 years.").
                            - **KPI 2:** Another measurable target.
                            `
                        }]
                    },
                };
                for (let i = 0; i < MAX_RETRIES; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        planText = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Error: AI content missing.';
                        break;
                    } else if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, 2 ** i * 1000));
                        if (i === MAX_RETRIES - 1) throw new Error("API rate limit exceeded.");
                    } else if (response.status === 403 && i === 0) {
                        errorEl.textContent = 'Error: API Key Required (403)';
                        errorEl.classList.remove('hidden');
                        throw new Error("API Key Missing or Invalid (403).");
                    } else {
                        throw new Error(`API returned status code ${response.status}`);
                    }
                }
                displayResults(planText);
            } catch (error) {
                console.error("Gemini API Error:", error);
                errorEl.textContent = `General Error: ${error.message}`;
                errorEl.classList.remove('hidden');
                document.getElementById('plan-display').classList.add('hidden');
                document.getElementById('data-layers-display').classList.add('hidden');
            } finally {
                button.disabled = false;
                buttonText.innerHTML = `Execute Protocol for KARACHI: <span id="current-tab-name">${tabData.title}</span>`;
                spinner.classList.add('hidden');
            }
        }

        function displayResults(planContent) {
            const planDisplayEl = document.getElementById('plan-content');
            planDisplayEl.innerHTML = marked.parse(planContent);
            document.getElementById('plan-display').classList.remove('hidden');
            const layers = getMentionedLayers(planContent);
            const dataLayersContentEl = document.getElementById('data-layers-content');
            dataLayersContentEl.innerHTML = '';
            document.getElementById('data-layers-display').classList.remove('hidden');

            if (layers.length > 0) {
                layers.forEach(layer => {
                    const card = document.createElement('div');
                    card.className = 'data-card p-5 rounded-lg border border-green-700 shadow-lg shadow-green-900/50 hover:shadow-green-500/50';
                    card.innerHTML = `
                        <p class="text-xs font-mono font-semibold text-green-400 mb-1 tracking-wider">${layer.data.source} LAYER / STATUS: ONLINE</p>
                        <h4 class="text-lg font-bold text-gray-100">${layer.data.title}</h4>
                        <p class="mt-3 text-gray-400">${layer.data.description}</p>
                        <span class="inline-block mt-4 px-3 py-1 text-xs font-extrabold text-green-100 bg-green-700 rounded-sm font-mono tracking-wider">${layer.keyword}</span>
                    `;
                    dataLayersContentEl.appendChild(card);
                });
            } else {
                dataLayersContentEl.innerHTML = '<p class="text-gray-400 p-4 bg-red-900/30 rounded-lg border border-red-700 text-sm">WARNING: Plan did not reference internal data layers. Check system instruction adherence.</p>';
            }
        }

        let charts = {};
        const renderChart = (ctx, type, data, options) => {
            const chartId = ctx.canvas.id;
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            charts[chartId] = new Chart(ctx, { type, data, options });
        };

        const createFeedContent = (dataObj) => {
            return `
                <div class="data-card p-4 text-xs text-gray-400">
                    <h4 class="font-bold text-cyan-400 mb-1 font-mono">FEED SOURCE:</h4>
                    <p class="text-gray-500">${dataObj.eoSource}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="data-card p-5 border-t-4 border-green-500">
                        <h3 class="text-sm font-semibold mb-1 text-green-400 font-mono">Status: ${dataObj.karachi.metric}</h3>
                        <p class="text-3xl font-extrabold text-green-500 font-mono">${dataObj.karachi.value}</p>
                    </div>
                    <div class="data-card p-5 border-t-4 border-cyan-500">
                        <h3 class="text-sm font-semibold mb-1 text-cyan-400 font-mono">${dataObj.nyc.benchmarkMetric}</h3>
                        <p class="text-3xl font-extrabold text-cyan-500 font-mono">${dataObj.nyc.benchmarkValue}</p>
                    </div>
                </div>
                <div class="data-card p-4 border-l-4 border-green-500 bg-green-900/20">
                    <h4 class="font-bold text-green-400 mb-1 font-mono">INSIGHT:</h4>
                    <p class="text-green-300">${dataObj.karachi.insight}</p>
                </div>
            `;
        };

        const createSimCrisisContent = (dataObj) => {
            return `
                <div class="data-card p-4 text-xs text-gray-400">
                    <h4 class="font-bold text-cyan-400 mb-1 font-mono">SIMULATION STATUS:</h4>
                    <p class="text-gray-500">${dataObj.eoSource}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="data-card p-5 border-t-4 border-green-500">
                        <h3 class="text-sm font-semibold mb-1 text-green-400 font-mono">${dataObj.karachi.metric}</h3>
                        <p class="text-3xl font-extrabold text-green-500 font-mono">${dataObj.karachi.value}</p>
                    </div>
                    <div class="data-card p-5 border-t-4 border-cyan-500">
                        <h3 class="text-sm font-semibold mb-1 text-cyan-400 font-mono">${dataObj.nyc.benchmarkMetric}</h3>
                        <p class="text-3xl font-extrabold text-cyan-500 font-mono">${dataObj.nyc.benchmarkValue}</p>
                    </div>
                </div>
                <div class="data-card p-4 border-l-4 border-green-500 bg-green-900/20">
                    <h4 class="font-bold text-green-400 mb-1 font-mono">SIMULATION INSIGHT:</h4>
                    <p class="text-green-300">${dataObj.karachi.insight}</p>
                </div>
                <div class="data-card p-4 border-l-4 border-cyan-500 bg-cyan-900/20">
                    <h4 class="font-bold text-cyan-400 mb-1 font-mono">ALLOCATION GOAL:</h4>
                    <p class="text-cyan-300">Achieve a Resilience Impact Score (RIS) > 7.0 by prioritizing high-leverage investments.</p>
                </div>
            `;
        };

        const createCrisisContent = (dataObj) => {
            const id = 'karachi-chart';
            let mapHtml = '';
            if (dataObj.map) {
                mapHtml = `
                <div class="data-card p-4 border-t-4 border-orange-500">
                    <h4 class="font-bold text-orange-400 mb-2 font-mono">${dataObj.map.title}</h4>
                    <div id="map" class="h-64 rounded-md shadow-lg border border-orange-700"></div>
                </div>
                `;
            }
            return `
                <div class="data-card p-4 text-xs text-gray-400">
                    <h4 class="font-bold text-cyan-400 mb-1 font-mono">DATA FLOW:</h4>
                    <p class="text-gray-500">${dataObj.eoSource}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="data-card p-5 border-t-4 border-red-500">
                        <h3 class="text-sm font-semibold mb-1 text-red-400 font-mono">${dataObj.karachi.metric}</h3>
                        <p class="text-3xl font-extrabold text-red-500 font-mono">${dataObj.karachi.value}</p>
                    </div>
                    <div class="data-card p-5 border-t-4 border-cyan-500">
                        <h3 class="text-sm font-semibold mb-1 text-cyan-400 font-mono">${dataObj.nyc.benchmarkMetric}</h3>
                        <p class="text-3xl font-extrabold text-cyan-500 font-mono">${dataObj.nyc.benchmarkValue}</p>
                    </div>
                </div>
                <div class="data-card p-4">
                    <canvas id="${id}" height="220"></canvas>
                </div>
                ${mapHtml}
                <div class="data-card p-4 border-l-4 border-red-500 bg-red-900/20">
                    <h4 class="font-bold text-red-400 mb-1 font-mono">CRITICAL INSIGHT (KARACHI):</h4>
                    <p class="text-red-300">${dataObj.karachi.insight}</p>
                </div>
                <div class="data-card p-4 border-l-4 border-cyan-500 bg-cyan-900/20">
                    <h4 class="font-bold text-cyan-400 mb-1 font-mono">BENCHMARK CONTEXT (NYC):</h4>
                    <p class="text-cyan-300">${dataObj.nyc.benchmarkInsight}</p>
                </div>
            `;
        };
        
        // --- UPDATED initializeMap FUNCTION ---
       function initializeMap(tabName) {
            if (map) {
                map.remove();
                map = null;
            }
            
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return;
            
            const karachiCoords = [24.8607, 67.0011];
            map = L.map('map').setView(karachiCoords, 11);
            
            const today = new Date();
            today.setDate(today.getDate() - 2);
            const dateStr = today.toISOString().split('T')[0];

            switch(tabName) {
                case 'mobility':
                    // Base Map Layer
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; CARTO'
                    }).addTo(map);

                    // Restored: NASA Population Density Layer (This is the one that was likely corrupted)
                    L.tileLayer('https://sedac.ciesin.columbia.edu/arcgis/rest/services/sedac/population-density-2020/ImageServer/tile/{z}/{y}/{x}', {
                        attribution: 'NASA SEDAC Population Density',
                        opacity: 0.6
                    }).addTo(map);
                    
                    // Restored: OpenRailwayMap Layer
                     L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenRailwayMap',
                        opacity: 0.8
                    }).addTo(map);

                    // New: Mock Congestion Data
                    const congestionData = [
                        {
                            name: 'Shahrah-e-Faisal',
                            level: 'High',
                            color: '#ef4444',
                            path: [[24.839, 67.088], [24.851, 67.067], [24.863, 67.049]]
                        },
                        {
                            name: 'M. A. Jinnah Road',
                            level: 'High',
                            color: '#ef4444',
                            path: [[24.864, 67.010], [24.875, 67.025], [24.890, 67.035]]
                        },
                        {
                            name: 'Korangi Road',
                            level: 'Medium',
                            color: '#f97316',
                            path: [[24.825, 67.075], [24.805, 67.100], [24.790, 67.125]]
                        },
                        {
                            name: 'Lyari Expressway',
                            level: 'Medium',
                            color: '#f97316',
                            path: [[24.885, 67.015], [24.930, 67.030], [24.965, 67.040]]
                        }
                    ];

                    congestionData.forEach(road => {
                        L.polyline(road.path, { 
                            color: road.color, 
                            weight: 5, 
                            opacity: 0.8 
                        }).addTo(map)
                          .bindPopup(`<h5>${road.name}</h5><p><b>Congestion Level:</b> ${road.level}</p>`);
                    });

                    // New: Map Legend
                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function (map) {
                        const div = L.DomUtil.create('div', 'info legend p-2 rounded-md bg-gray-800 bg-opacity-80 text-white font-mono text-xs');
                        const grades = [
                            {level: 'High Congestion', color: '#ef4444'},
                            {level: 'Medium Congestion', color: '#f97316'}
                        ];
                        div.innerHTML += '<b>Mobility Layers</b><br>';
                        grades.forEach(grade => {
                            div.innerHTML += `<i class="inline-block w-3 h-3 mr-1" style="background:${grade.color}"></i> ${grade.level}<br>`;
                        });
                        div.innerHTML += '<i class="inline-block w-3 h-3 mr-1 opacity-60" style="background:white"></i> Population Density';
                        return div;
                    };
                    legend.addTo(map);
                    break;

                case 'housing':
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
                    MAP_DATA.informalSettlements.forEach(site => {
                        L.marker([site.lat, site.lon], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color: #f59e0b; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff;"></div>`, iconSize: [12, 12], iconAnchor: [6, 6] }) }).addTo(map).bindPopup(`<h5>${site.name}</h5><p>${site.detail}</p>`);
                    });
                    break;
                
                case 'air':
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
                    L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/Sentinel5P_L3_NO2_Column_Density/default/' + dateStr + '/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png', { attribution: 'NASA GIBS', opacity: 0.6 }).addTo(map);
                    MAP_DATA.pollutionHotspots.forEach(hotspot => {
                        let color;
                        switch(hotspot.severity) { case 'Critical': color = '#ef4444'; break; case 'High': color = '#f97316'; break; case 'Medium': color = '#f59e0b'; break; default: color = '#84cc16'; }
                        L.circleMarker([hotspot.lat, hotspot.lon], { radius: 8, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8 }).addTo(map).bindPopup(`<h5>${hotspot.name}</h5><p><b>Severity:</b> ${hotspot.severity}<br><b>Sources:</b> ${hotspot.type}</p>`);
                    });
                    break;

                case 'coastal':
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri &mdash; Source: Esri, i-cubed, USDA, USGS' }).addTo(map);
                    L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Aqua_CorrectedReflectance_TrueColor/default/'+ dateStr +'/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', { attribution: 'NASA GIBS', opacity: 0.5 }).addTo(map);
                    MAP_DATA.coastalAssets.forEach(asset => {
                        const color = asset.type === 'Protected Ecosystem' ? '#22c55e' : '#f43f5e';
                        L.marker([asset.lat, asset.lon], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff;"></div>`, iconSize: [12, 12], iconAnchor: [6, 6] }) }).addTo(map).bindPopup(`<h5>${asset.name}</h5><p>${asset.type}</p>`);
                    });
                    break;

                case 'waste':
                     L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri &mdash; Source: Esri, i-cubed, USDA, USGS' }).addTo(map);
                    MAP_DATA.wasteSites.forEach(site => {
                        const color = site.type === 'Official Landfill' ? '#38bdf8' : '#e11d48';
                         L.marker([site.lat, site.lon], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border: 2px solid #fff;"></div>`, iconSize: [12, 12], iconAnchor: [6, 6] }) }).addTo(map).bindPopup(`<h5>${site.name}</h5><p>${site.type}</p>`);
                    });
                    break;
            }
        }
           
        const updateDashboard = (tabName) => {
            const crisisContent = document.getElementById('content-crisis');
            const actionContent = document.getElementById('default-message');
            const feedContent = document.getElementById('feed-content');
            const simContent = document.getElementById('sim-content');

            document.getElementById('plan-display').classList.add('hidden');
            document.getElementById('data-layers-display').classList.add('hidden');
            actionContent.classList.remove('hidden');
            feedContent.classList.add('hidden');
            simContent.classList.add('hidden');

            const tabData = CRISIS_DATA[tabName];
            
            if (tabData.isFeed) {
                feedContent.classList.remove('hidden');
                actionContent.classList.add('hidden');
                crisisContent.innerHTML = createFeedContent(tabData);
            } else if (tabData.isSim) {
                simContent.classList.remove('hidden');
                actionContent.classList.add('hidden');
                crisisContent.innerHTML = createSimCrisisContent(tabData);
            } else {
                crisisContent.innerHTML = createCrisisContent(tabData);
            }
            
            // This timeout ensures the DOM has updated before initializing maps/charts
            setTimeout(() => {
                initializeMap(tabName);
                
                if (!tabData.isFeed && !tabData.isSim) {
                    const commonOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    boxWidth: 12, 
                                    padding: 20, 
                                    color: '#9CA3AF', 
                                    font: { family: 'Roboto Mono' } 
                                } 
                            },
                            title: { 
                                display: true, 
                                text: `${tabData.title} DATA BREAKDOWN`, 
                                font: { size: 14, weight: 'bold', family: 'Roboto Mono' }, 
                                color: '#F9FAFB', 
                                padding: { bottom: 15 } 
                            }
                        },
                        layout: { padding: 10 },
                        cutout: '70%',
                    };

                    const karachiChartData = {
                        labels: tabData.karachi.chartData.labels,
                        datasets: [{
                            data: tabData.karachi.chartData.values,
                            backgroundColor: tabData.karachi.chartData.bg,
                            hoverOffset: 16,
                            borderWidth: 2,
                            borderColor: '#1F2937'
                        }]
                    };
                    
                    const chartCanvas = document.getElementById('karachi-chart');
                    if(chartCanvas) {
                        const karachiCtx = chartCanvas.getContext('2d');
                        renderChart(karachiCtx, 'doughnut', karachiChartData, commonOptions);
                    }
                }
            }, 0);
            
            const crisisColumn = document.getElementById('crisis-column');
            const actionPlanColumn = document.getElementById('action-plan-column');
            document.getElementById('current-tab-name').textContent = tabData.title;

            if (tabData.isSim) {
                crisisColumn.classList.add('hidden');
                actionPlanColumn.classList.remove('lg:col-span-2');
                actionPlanColumn.classList.add('lg:col-span-3');
                document.getElementById('sim-results').classList.add('hidden');
                updateSimTotal();
            } else {
                crisisColumn.classList.remove('hidden');
                actionPlanColumn.classList.remove('lg:col-span-3');
                actionPlanColumn.classList.add('lg:col-span-2');
            }

            const generateBtn = document.getElementById('generate-plan-btn');
            const buttonTextEl = document.getElementById('button-text');

            if (tabData.isFeed || tabData.isSim) {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50');
                buttonTextEl.textContent = 'PROTOCOL UNAVAILABLE FOR THIS TAB';
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50');
                buttonTextEl.innerHTML = `Execute Protocol for KARACHI: <span id="current-tab-name">${tabData.title}</span>`;
            }
        };

        document.getElementById('generate-plan-btn').addEventListener('click', () => {
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                const tabData = CRISIS_DATA[activeTab.dataset.tab];
                if (tabData && !tabData.isFeed && !tabData.isSim) {
                    generatePlanAndData(activeTab.dataset.tab);
                }
            }
        });

        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                tabs.forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active');
                updateDashboard(e.currentTarget.dataset.tab);
            });
        });

        window.onload = async () => {
            const liveAqi = await fetchLiveAQI();

            if (liveAqi !== null) {
                const liveAqiNumber = parseInt(liveAqi);
                CRISIS_DATA.air.karachi.value = liveAqi.toString();
                CHART_COLORS.air.values[0] = liveAqiNumber;
                CHART_COLORS.air.labels[0] = `PM2.5 Level (Live: ${liveAqiNumber})`;
            }

            const defaultTab = 'mobility';
            document.getElementById(`tab-${defaultTab}`).click();
        };

        document.getElementById('generate-plan-btn').disabled = false;
    </script>
</body>
</html>
